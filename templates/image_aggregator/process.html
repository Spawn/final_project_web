{% extends 'base.html' %}
{% load static %}
{% block content %}

<!DOCTYPE html>
<html>
   <head>
      <script type="text/javascript">
         var socket = null;
         var isopen = false;
         document.getElementById('search-form').style.display='none';

         window.onload = function() {

            socket = new WebSocket("ws://127.0.0.1:9000");
            socket.binaryType = "arraybuffer";

            socket.onopen = function() {
               console.log("Connected!");
               socket.send(getCookie('csrfmiddlewaretoken'));
               isopen = true;
            };

            socket.onmessage = function(e) {
               if (typeof e.data == "string") {
                  console.log("Text message received: " + e.data);
                  console.log(document.cookie);
                   if (e.data == "Google True") {
                       document.getElementById('google-process').style.display='none';
                       document.getElementById('google-success').style.display='block'
                   }
                   if (e.data == "Yandex True") {
                       document.getElementById('yandex-process').style.display='none';
                       document.getElementById('yandex-success').style.display='block'
                   }
                   if (e.data == "Instagram True") {
                       document.getElementById('instagram-process').style.display='none';
                       document.getElementById('instagram-success').style.display='block'
                   }
                   if (~e.data.indexOf("error")) {
                       document.getElementById(e.data).style.display='block';
                       index = e.data.indexOf('-');
                       document.getElementById(e.data.substring(0, index) + '-process').style.display='none'
                   }
                   if (e.data == "DONE") {
                       document.getElementById('link').style.display='block'
                   }
               } else {
                  var arr = new Uint8Array(e.data);
                  var hex = '';
                  for (var i = 0; i < arr.length; i++) {
                     hex += ('00' + arr[i].toString(16)).substr(-2);
                  }
                  console.log("Binary message received: " + hex);
               }
            };

            socket.onclose = function(e) {
               console.log("Connection closed.");
               socket = null;
               isopen = false;
            }
         };

         function sendText() {
            if (isopen) {
               socket.send(getCookie('csrftoken'));
               console.log("Text message sent.");
            } else {
               console.log("Connection not opened.")
            }
         }

         function getCookie(name) {
            var matches = document.cookie.match(new RegExp(
                "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
            ));
            return matches ? decodeURIComponent(matches[1]) : undefined;
         }
      </script>

    </head>
        <body>
            <div id="google-success" class="alert alert-success" role="alert">
                <a href="#" class="alert-link">Google OK</a>
            </div>
            <div id="google-process" class="alert alert-warning" role="alert">
                <a href="#" class="alert-link">Google Process</a>
            </div>
            <div id="google-error" class="alert alert-danger" role="alert">
                <a href="#" class="alert-link">Google Error</a>
            </div>
            <div id="yandex-success" class="alert alert-success" role="alert">
                <a href="#" class="alert-link">Yandex OK</a>
            </div>
            <div id="yandex-process" class="alert alert-warning" role="alert">
                <a href="#" class="alert-link">Yandex Process</a>
            </div>
            <div id="yandex-error" class="alert alert-danger" role="alert">
                <a href="#" class="alert-link">Yandex Error</a>
            </div>
            <div id="instagram-success" class="alert alert-success" role="alert">
                <a href="#" class="alert-link">Instagram OK</a>
            </div>
            <div id="instagram-process" class="alert alert-warning" role="alert">
                <a href="#" class="alert-link">Instagram Process</a>
            </div>
            <div id="instagram-error" class="alert alert-danger" role="alert">
                <a href="#" class="alert-link">Instagram Error</a>
            </div>
            <div id="link" class="alert alert-info" role="alert">
                <a id="result" class="alert-link" onclick="window.location = '/result/'">Show results</a>
            </div>
   </body>
</html>

{% endblock %}